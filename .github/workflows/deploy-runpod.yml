name: Deploy to RunPod Serverless

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      endpoint_id:
        description: 'RunPod Endpoint ID (optional, override ENV)'
        required: false

env:
  REGISTRY: docker.io
  # RunPod supports Docker Hub and other registries
  # Change to your Docker Hub username or use RunPod's registry
  IMAGE_NAME: ${{ secrets.DOCKER_HUB_USERNAME || 'your-username' }}/maya1-runpod-serverless

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      if: github.event_name != 'workflow_dispatch' || github.event.inputs.endpoint_id == ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
    
    - name: Output deployment info
      run: |
        echo "## Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version || 'latest' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Update your RunPod serverless endpoint with the new Docker image" >> $GITHUB_STEP_SUMMARY
        echo "2. Set environment variables in RunPod dashboard:" >> $GITHUB_STEP_SUMMARY
        echo "   - FIREBASE_SERVICE_ACCOUNT_KEY" >> $GITHUB_STEP_SUMMARY
        echo "   - FIREBASE_STORAGE_BUCKET (optional)" >> $GITHUB_STEP_SUMMARY
        echo "3. Or use RunPod API/CLI to update the endpoint" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Docker Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version || 'latest' }}"
    
    - name: Deploy to RunPod (Optional)
      if: secrets.RUNPOD_API_KEY != '' && secrets.RUNPOD_ENDPOINT_ID != ''
      env:
        RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
        DOCKER_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version || 'latest' }}
      run: |
        echo "Attempting to update RunPod endpoint..."
        # Use RunPod API to update endpoint (this requires the endpoint to already exist)
        # For initial deployment, create the endpoint manually via RunPod dashboard first
        RESPONSE=$(curl -s -X POST \
          "https://api.runpod.io/graphql?api_key=$RUNPOD_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"query\": \"mutation updateEndpoint(\$input: EndpointUpdateInput!) { updateEndpoint(input: \$input) { id name templateId workersMax workersMin } }\",
            \"variables\": {
              \"input\": {
                \"endpointId\": \"$ENDPOINT_ID\",
                \"templateId\": \"your-template-id\"
              }
            }
          }" || echo "{}")
        
        if echo "$RESPONSE" | grep -q "errors"; then
          echo "API update failed. Please update the endpoint manually in RunPod dashboard."
          echo "Response: $RESPONSE"
        else
          echo "Endpoint update initiated successfully"
        fi

